async def finish_diagnostics(message: Message, state: FSMContext):
    data = await state.get_data()
    # Берём оригинальные баллы (без +3 от tie-breaker)
    scores = data.get("scores_original", data.get("scores", [0] * len(PROGRAMS)))

    program_scores = list(zip(PROGRAMS, scores))
    program_scores.sort(key=lambda x: x[1], reverse=True)
    top3 = program_scores[:3]

    # 1. Короткое сообщение с топ-3 и баллами
    text_top = "Диагностика завершена ❤️\n\nТвои топ-3 программы:\n\n"
    for i, (prog, score) in enumerate(top3, 1):
        text_top += f"{i}. {prog} — {score} баллов\n"

    # Получаем топ-1 для персонализации
    top1_name = top3[0][0] if top3 else "программа"

    # Краткое описание топ-1 (можно вынести в словарь, если нужно)
    program_short_desc = {
        "Вечная пустота": "уже создаёт ощущение, что внутри всегда чего-то не хватает",
        "Меня оставят": "уже заставляет бояться, что близкие уйдут или охладеют",
        "Хрупкость": "уже делает любое замечание очень болезненным",
        "Жертва ради других": "уже заставляет отдавать последнее, а потом обижаться",
        "Внутренний критик": "уже ругает за малейшие ошибки и не даёт расслабиться",
        "Никому не верю": "уже держит в постоянном ожидании обмана или предательства",
        "Не дотягиваю": "уже вызывает чувство, что ты хуже/недостойнее других",
        "Зависимость": "уже делает невозможным принимать решения без чужого совета",
        "Жажда похвалы": "уже заставляет менять себя ради чужого одобрения",
        "Я для всех": "уже заставляет соглашаться со всеми, чтобы не потерять любовь",
        "Замороженные чувства": "уже подавляет эмоции, чтобы не казаться слабым",
        "Саботаж успеха": "уже мешает доводить дела до конца и достигать целей",
        "Не могу себя заставить": "уже откладывает важные дела и вызывает самокритику",
        "Никто не нужен": "уже создаёт ощущение, что ты никому по-настоящему не нужен",
        "Всё плохо": "уже заставляет видеть только худшие сценарии",
        "Я - это ты": "уже растворяет тебя в партнёре, теряя свои желания",
        "Внутренний судья": "уже строго судит ошибки и не прощает",
        "Я лучше/хуже всех": "уже вызывает перепады от чувства превосходства до ничтожности"
    }

    top1_desc = program_short_desc.get(top1_name, "уже сильно влияет на твою жизнь")

    text_top += f"\nСейчас особенно активно проявляет себя **{top1_name}** ({top1_desc}).\n\n"
    text_top += "Это та часть тебя, которая сейчас сильнее всего влияет на то, как ты строишь отношения, выбираешь людей, относишься к себе и двигаешься по жизни.\n"
    text_top += "Хочешь лучше её понять и увидеть, как можно постепенно её менять?\n\n"
    text_top += "Выбери, какой формат тебе ближе ↓"

    await message.answer(text_top, parse_mode="HTML")

    # 2. Отдельные сообщения с полными описаниями топ-3
    for i, (prog, score) in enumerate(top3, 1):
        desc = PROGRAM_DESCRIPTIONS[PROGRAMS.index(prog)]
        text_desc = f"<b>{i}. {prog}</b>\n\n{desc}"
        await message.answer(text_desc, parse_mode="HTML")
        await asyncio.sleep(0.8)  # пауза против флуда

    # 3. Кнопки с выбором
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Полный разбор в файле — 699₽", callback_data="buy_full")],
        [InlineKeyboardButton(text="Мини-разбор (30–40 мин) — 1000₽", callback_data="buy_mini")],
        [InlineKeyboardButton(text="Полная консультация — 6000₽ (вместо 8000₽)", callback_data="buy_consult")]
    ])

    await message.answer("Выбери формат ниже:", reply_markup=keyboard)

    # 4. Обработчики кнопок (добавь эти хендлеры в код, если их ещё нет)
    @dp.callback_query(lambda c: c.data == "buy_full")
    async def buy_full(callback: CallbackQuery):
        text = """<b>Полный разбор в файле — 699₽</b>

Что ты получишь:
• Подробное описание твоей топ-1 программы "{top1_name}" + двух остальных
• Как именно она влияет на:
  — отношения и выбор партнёра
  — карьеру и деньги
  — самооценку и здоровье
• Какие родительские программы ты можешь передавать своим детям (если не работать над этим)
• Конкретные рекомендации, что можно делать уже сейчас

Это подробная письменная карта твоей внутренней системы. 
Многие говорят, что после прочтения файла многое встаёт на свои места.

Хочешь получить файл? Нажми кнопку оплаты ниже."""
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="Оплатить 699₽ и получить файл", callback_data="pay_full")]
        ])
        await callback.message.answer(text, reply_markup=keyboard, parse_mode="HTML")
        await callback.answer()

    @dp.callback_query(lambda c: c.data == "buy_mini")
    async def buy_mini(callback: CallbackQuery):
        text = """<b>Мини-разбор (30–40 минут) — 1000₽</b>

Это личный разговор со мной.

Что мы сделаем:
• Разберём одну конкретную ситуацию, которая тебя сейчас больше всего беспокоит
• Посмотрим, какая программа стоит за ней
• Я помогу распутать, почему это происходит и что с этим можно сделать

Это не глубокая долгосрочная работа, но очень хорошая возможность получить ясность и первые шаги.

Подходит, если хочешь быстро получить ответ на волнующий вопрос.

Хочешь записаться на мини-разбор? Нажми кнопку ниже."""
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="Записаться на мини-разбор — 1000₽", callback_data="pay_mini")]
        ])
        await callback.message.answer(text, reply_markup=keyboard, parse_mode="HTML")
        await callback.answer()

    @dp.callback_query(lambda c: c.data == "buy_consult")
    async def buy_consult(callback: CallbackQuery):
        text = """<b>Полная консультация — 6000₽ (вместо 8000₽)</b>

Это уже глубокая и полноценная работа со мной.

Что входит:
• Разбор твоего главного запроса и топ-программ
• Поиск настоящей причины, почему это происходит
• Работа с корнем (включая родовые программы)
• Внутренняя перестройка — как перестать жить по старым сценариям
• Конкретная стратегия изменений и поддержка на ближайший период

Это не просто разговор «что делать», а настоящая глубокая работа над тем, чтобы программы перестали управлять твоей жизнью.

Для тех, кто прошёл диагностику — специальная цена 6000₽ вместо 8000₽.

Хочешь записаться на консультацию? Нажми кнопку ниже."""
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="Записаться на консультацию — 6000₽", callback_data="pay_consult")]
        ])
        await callback.message.answer(text, reply_markup=keyboard, parse_mode="HTML")
        await callback.answer()

    await state.clear()
